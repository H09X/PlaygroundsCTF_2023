## Challenge - Craig [Rev]

### Description

```
With rhyme and reason, you must explore,
The secrets he guards, on this digital floor.
Solve the enigma, unlock the rhyme,
To unearth treasures frozen in time.

But remember, in Minecraft's digital spree,
The poet's mood may not always agree.
So tread with care, be sharp, be shrewd,
For the rewards are grand, but his temper's not good.
```

---

### Reversing the Binary 

#### Analyzing Main

Below we can see the decompiled ```main``` function. 

```c
undefined8 FUN_001160ab(void)

{
  int iVar1;
  time_t tVar2;
  char *__s1;
  long lVar3;
  char local_6d8 [1612];
  int RANDNUM;
  undefined local_88 [120];
  
  tVar2 = time((time_t *)0x0);
  srand((uint)tVar2);
  do {
    puts(
        "In the digital realm, I roam and strive,\nGive me the input, let\'s take a dive.\nA hidden  number, I\'ll seek with delight,\nGuess it right, and the flag\'s in sight!:"
        );
    __isoc99_scanf(&DAT_00117202,local_88);
    __isoc99_scanf(&DAT_00117205,&RANDNUM);
    lVar3 = (long)RANDNUM;
    __s1 = (char *)FUN_00115f6e(local_88);
    iVar1 = strcmp(__s1,local_6d8 + lVar3 * 0x10);
    if (iVar1 == 0) {
      iVar1 = rand();
      if (iVar1 == RANDNUM) {
        FUN_00115f5d();
        return 0;
      }
    }
    puts("Dimwit, your input\'s out of sync, no flag to link.");
    sleep(2);
    system("clear");
  } while( true );
}
```

**Analysis:** Clearly this main function prompts us w/ two inputs. A string and a number. If they match the values generated by the code, the function ```FUN_00115f5d();``` is called.

---

#### Analyzing 

With sufficient analysis of ```FUN_00115f5d()``` we can backtrack to this decompiled bit of code: 

```c 

void FUN_00101229(void)

{
  int local_88 [4];
  undefined4 local_78;
  undefined4 local_74;
  undefined4 local_70;
  undefined4 local_6c;
  undefined4 local_68;
  undefined4 local_64;
  undefined4 local_60;
  undefined4 local_5c;
  undefined4 local_58;
  undefined4 local_54;
  undefined4 local_50;
  undefined4 local_4c;
  undefined4 local_48;
  undefined4 local_44;
  undefined4 local_40;
  undefined4 local_3c;
  undefined4 local_38;
  undefined4 local_34;
  undefined4 local_30;
  undefined4 local_2c;
  undefined4 local_28;
  undefined4 local_24;
  undefined4 local_20;
  undefined4 local_1c;
  undefined4 local_18;
  int local_c;
  
  local_88[0] = 0x52;
  local_88[1] = 99;
  local_88[2] = 0x61;
  local_88[3] = 0x67;
  local_78 = 0x6d;
  local_74 = 0x74;
  local_70 = 0x66;
  local_6c = 0x75;
  local_68 = 0x76;
  local_64 = 0x6a;
  local_60 = 0x75;
  local_5c = 0x54;
  local_58 = 0x54;
  local_54 = 0x4e;
  local_50 = 0x7b;
  local_4c = 0x42;
  local_48 = 0x67;
  local_44 = 0x49;
  local_40 = 0x24;
  local_3c = 0x45;
  local_38 = 0x5f;
  local_34 = 0x7a;
  local_30 = 0x6b;
  local_2c = 0x58;
  local_28 = 0x76;
  local_24 = 0x72;
  local_20 = 0x35;
  local_1c = 0x4d;
  local_18 = 0x7d;
  puts(
      "\n\nYou seek the flag, oh so grand,\nBut finding me was not as planned.\nWorry not, my dear l ittle mate,\nA hint I\'ll give to ease your state.\n\nBlaise, oh Blaise, he holds the key,\nTh e flag will be his gift to thee.\nSo go ahead and seek his aid,\nAnd soon the flag will be dis played.\n"
      );
  puts("\n\nEnc Flag:");
  for (local_c = 0; local_c < 0x1d; local_c = local_c + 1) {
    putchar(local_88[local_c]);
  }
  putchar(10);
  sleep(0);
  system("clear");
  printf("Patching detected\nNice try");
  return;
}
```

Clearly this outputs the encrypted flag. We need to somehow bypass the checks to call this function. 

**NOTE** This challenge has a twist - it calls the clear command on its output - as shown in the function above and in the main function. 

---

### Solution 

1) We can patch the binary to bypass the checks given in the main function. 

Fire up ida, and patch the program as shown below. 

Main Function Before: 

![image](https://github.com/bmadc/docker-tomcat-tutorial/assets/141595076/e73a645c-ff50-48be-a0cf-454931c8245c)

Main Function After: 

![image](https://github.com/bmadc/docker-tomcat-tutorial/assets/141595076/9d37439d-1abe-4bfc-a685-076c1c2ac897)

**Explanation:** Simply use the ```jmp``` instruction to bypass all checks. 

2) Remember as mentioned above, the ```clear``` command is called on the output. So we need to run the binary as follows: 
```bash
┌──(H04X㉿M0tH3r5h1P)-[~]
└─$ ./Craig > ct.txt
meh1
meh2
```
**NOTE** Since we patched the binary, just provide any two random inputs. 

3) Observing the contents of ct.txt
```
In the digital realm, I roam and strive,
Give me the input, let's take a dive.
A hidden number, I'll seek with delight,
Guess it right, and the flag's in sight!:


You seek the flag, oh so grand,
But finding me was not as planned.
Worry not, my dear little mate,
A hint I'll give to ease your state.

Blaise, oh Blaise, he holds the key,
The flag will be his gift to thee.
So go ahead and seek his aid,
And soon the flag will be displayed.



Enc Flag:
RcagmtfuvjuTTN{BgI$E_zkXvr5M}
Patching detected
Nice try     
```
***NOTE*** An alternative way to bypass the clear would be 

```bash
┌──(H04X㉿M0tH3r5h1P)-[~]
└─$ sudo chmod -x /usr/bin/clear

┌──(H04X㉿M0tH3r5h1P)-[~]
└─$ ./Craig
```


4) From the hint provided in the poem (Blaise) - the encryption used here is the Vigenere Cipher. Using [dcode](https://www.dcode.fr/vigenere-cipher) we can decrypt and get the flag: ```PlaygroundsCTF{VeR$E_reVer5E}```



